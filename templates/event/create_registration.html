{% extends "allauth/layouts/main_base.html" %}
{% load static %}
{% block head_title %}Create Registration{% endblock head_title %}
{% block stylesheet %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
  .hidden { display: none; }
  .select2-container {
      width: 100% !important;
  }
</style>
{% endblock stylesheet %}

{% block pages %}
<main>
    <h1>Create a Registration</h1>
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="all_clubs_members" value={{all_clubs_members}}></input>
        {{ registration_form.as_p }}

        <div class="button-container">
            <button type="submit">Save</button>
        </div>
    </form>
</main>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    const all_clubs_members = JSON.parse('{{ all_clubs_members|escapejs }}');
    console.log(all_clubs_members); // Debugging: Ensure this logs correctly
</script>


<script>
    document.addEventListener("DOMContentLoaded", function () {

        const invitedUsersField = $('#id_invited_users');
        invitedUsersField.select2({
            placeholder: "Select invited users",
            allowClear: true
        });


        
        function updateinvitedusers() { 
            const invitedclubs = document.getElementById("id_invited_club");
            const invitedusers = document.getElementById("id_invited_users");

            // Get selected clubs
            const selectedClubs = Array.from(invitedclubs.selectedOptions).map(option => option.value);

            // Deselect all current options in invitedusers
            Array.from(invitedusers.options).forEach(option => option.selected = false);

            // If no club is selected, exit the function
            if (selectedClubs.length === 0) {
                return;
            }

            // Iterate over selected clubs and select corresponding members
            selectedClubs.forEach(clubId => {
                all_clubs_members.forEach(clubData => {
                    if (clubData.club.id == clubId) {
                        const clubMembers = clubData.all_members;
                        console.log(clubMembers);
                        // Select the members of the current club in invitedusers
                        clubMembers.forEach(member => {
                            console.log(invitedusers.options);
                            const matchingOption = Array.from(invitedusers.options).find(
                                option => option.value == member.id
                            );
                            if (matchingOption) {
                                matchingOption.selected = true;
                            }
                        });
                    }
                });
                invitedUsersField.trigger('change');
            });
        }

        // Attach the function to the change event
        document.getElementById("id_invited_club").addEventListener("change", updateinvitedusers);

    });
</script>
{% endblock pages %}
